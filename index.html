<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå°Ô∏è SCADA - Monitoreo y Control Ambiental BLE</title>
    <style>
        /* Paleta de Colores Estilo SCADA: */
        /* Fondo Oscuro */
        :root {
            --bg-dark: #2c3e50; /* Azul/Gris oscuro */
            --bg-card: #34495e; /* Fondo de tarjetas */
            --text-light: #ecf0f1; /* Texto general (blanco/gris claro) */
            --color-ok: #2ecc71; /* Verde es OK/Encendido */
            --color-alarm: #e74c3c; /* Rojo es Alarma/Apagado (para contrastar) */
            --color-highlight: #f39c12; /* Naranja/Amarillo para Promedio/Destacado */
            --color-info: #3498db; /* Azul para estado de conexi√≥n */
        }

        body {
            font-family: 'Consolas', monospace; /* Fuente de estilo t√©cnico */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: var(--bg-dark);
            color: var(--text-light);
        }
        h1, h2 {
            color: var(--text-light);
            text-shadow: 1px 1px 2px #000;
        }
        button, .mode-switch {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            margin: 5px;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #connectButton {
            background-color: var(--color-info);
            color: white;
            margin-bottom: 20px;
        }
        #connectButton:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .status {
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--color-highlight);
        }
        .control-panel, .sensor-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            border: 2px solid var(--color-highlight);
            border-radius: 10px;
            background-color: var(--bg-card);
            width: 90%;
            max-width: 800px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .sensor-card, .actuator-card {
            background-color: var(--bg-dark);
            border: 1px solid var(--text-light);
            border-radius: 8px;
            padding: 10px;
            width: 120px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        .temperature {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--color-alarm); /* Temperaturas en rojo/alarma por defecto */
        }
        #temp_avg {
            color: var(--color-highlight); /* Promedio en amarillo/naranja */
        }
        
        /* Estilos para el Switch */
        .mode-switch-container { text-align: center; margin-bottom: 10px; width: 100%; }
        .mode-label { font-weight: bold; margin-bottom: 10px; color: var(--color-info); }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-alarm); 
            transition: .4s;
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text-light); 
            transition: .4s;
        }
        input:checked + .slider { background-color: var(--color-ok); }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .mode-text { font-size: 1.2em; font-weight: bold; margin: 0 15px; color: #555; }
        #auto-text { color: var(--color-ok); } /* Autom√°tico en Verde */
        #manual-text { color: var(--color-alarm); } /* Manual en Rojo */
        
        /* Estilos Actuadores */
        .actuator-card { background-color: var(--bg-card); }
        
        /* Botones de control manual */
        .actuator-card button.on { background-color: var(--color-ok); color: var(--bg-dark); }
        .actuator-card button.off { background-color: var(--color-alarm); color: var(--text-light); }
        .actuator-card button:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Estado real del actuador */
        .actuator-status { 
            font-weight: bold; 
            margin-top: 5px;
            color: var(--color-alarm);
        }
        .actuator-status.on {
            color: var(--color-ok);
        }

        /* Estilos del Modal (Reemplazo de alert/prompt) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--bg-card);
            border: 2px solid var(--color-highlight);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }
        .modal-content h3 {
            color: var(--color-highlight);
            margin-bottom: 15px;
        }
        #passwordInput {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid var(--text-light);
            background-color: var(--bg-dark);
            color: var(--text-light);
            text-align: center;
            font-size: 1em;
        }
        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
        }
        .message-area {
            min-height: 20px;
            color: var(--color-alarm);
            font-weight: bold;
            margin-top: 10px;
        }
        .modal-overlay.show {
            display: flex;
        }
        
    </style>
</head>
<body>
    <h1>SCADA Term√≥metros Multipunto</h1>
    
    <div id="status" class="status">Desconectado. Pulsa Conectar.</div>
    <button id="connectButton">Conectar a ESP32</button>

    <div class="control-panel">
        <h2>Control de Actuadores</h2>
        
        <div class="mode-switch-container">
            <span id="manual-text" class="mode-text">MANUAL</span>
            <label class="switch">
                <input type="checkbox" id="modeSwitch" checked>
                <span class="slider round"></span>
            </label>
            <span id="auto-text" class="mode-text">AUTOM√ÅTICO</span>
            <div class="mode-label">Modo Actual: <span id="currentMode">Autom√°tico</span></div>
        </div>

        <div class="actuator-card" id="fanControl">
            <h3>Ventilador</h3>
            <button id="fanOnButton" class="on">ON</button>
            <button id="fanOffButton" class="off">OFF</button>
            <div id="fanStatus" class="actuator-status">Estado: OFF</div>
        </div>
        
        <div class="actuator-card" id="heaterControl">
            <h3>Calefactor</h3>
            <button id="heaterOnButton" class="on">ON</button>
            <button id="heaterOffButton" class="off">OFF</button>
            <div id="heaterStatus" class="actuator-status">Estado: OFF</div>
        </div>
    </div>
    
    <h2>Lecturas de Temperatura (¬∞C)</h2>

    <div class="sensor-container">
         <div class="sensor-card">
            <h3>PROMEDIO</h3>
            <div id="temp_avg" class="temperature">--.-</div>
        </div>
        <div class="sensor-card">
            <h3>Sensor 1 (S1)</h3>
            <div id="temp_s1" class="temperature">--.-</div>
        </div>
        <div class="sensor-card">
            <h3>Sensor 2 (S2)</h3>
            <div id="temp_s2" class="temperature">--.-</div>
        </div>
        <div class="sensor-card">
            <h3>Sensor 3 (S3)</h3>
            <div id="temp_s3" class="temperature">--.-</div>
        </div>
        <div class="sensor-card">
            <h3>Sensor 4 (S4)</h3>
            <div id="temp_s4" class="temperature">--.-</div>
        </div>
    </div>
    
    <!-- Custom Password Modal para Modo Manual -->
    <div id="passwordModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Acceso a Modo Manual</h3>
            <p>Introduce la contrase√±a para cambiar a Modo MANUAL.</p>
            <input type="password" id="passwordInput" placeholder="Contrase√±a (1234)">
            <div id="passwordMessage" class="message-area"></div>
            <div class="modal-actions">
                <button id="modalConfirm" class="on">Confirmar</button>
                <button id="modalCancel" class="off">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE SEGURIDAD ---
        const MANUAL_MODE_PASSWORD = "1234"; 

        // --- UUIDs (Deben coincidir con tu c√≥digo ESP32) ---
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const NOTIFY_CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const CONTROL_CHARACTERISTIC_UUID = '6e400002-b5a3-f39f-e0a9-e50e24dcca9e';

        // Variables BLE
        let device, server, service, notifyCharacteristic, controlCharacteristic;

        // Elementos de la interfaz y estado de control
        const statusDiv = document.getElementById('status');
        const connectButton = document.getElementById('connectButton');
        const modeSwitch = document.getElementById('modeSwitch');
        const currentModeDisplay = document.getElementById('currentMode');
        const manualText = document.getElementById('manual-text');
        const autoText = document.getElementById('auto-text');
        
        const fanControlDiv = document.getElementById('fanControl');
        const heaterControlDiv = document.getElementById('heaterControl');
        const fanOnButton = document.getElementById('fanOnButton');
        const fanOffButton = document.getElementById('fanOffButton');
        const heaterOnButton = document.getElementById('heaterOnButton');
        const heaterOffButton = document.getElementById('heaterOffButton');
        const fanStatusDiv = document.getElementById('fanStatus');
        const heaterStatusDiv = document.getElementById('heaterStatus');

        const tempsDivs = {
            avg: document.getElementById('temp_avg'),
            s1: document.getElementById('temp_s1'),
            s2: document.getElementById('temp_s2'),
            s3: document.getElementById('temp_s3'),
            s4: document.getElementById('temp_s4')
        };
        
        // Elementos del Modal de Contrase√±a
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordMessage = document.getElementById('passwordMessage');
        const modalConfirm = document.getElementById('modalConfirm');
        const modalCancel = document.getElementById('modalCancel');
        
        let controlState = {
            mode: 1,      // 1: Autom√°tico, 0: Manual
            fan_man: 0,   // Control Manual Ventilador
            heat_man: 0   // Control Manual Calefactor
        };


        // --- Event Listeners ---
        connectButton.addEventListener('click', connectToBLE);
        modeSwitch.addEventListener('change', handleModeChange);
        fanOnButton.addEventListener('click', () => setManualControl('fan', 1));
        fanOffButton.addEventListener('click', () => setManualControl('fan', 0));
        heaterOnButton.addEventListener('click', () => setManualControl('heat', 1));
        heaterOffButton.addEventListener('click', () => setManualControl('heat', 0));
        
        // Listeners para el Modal
        modalConfirm.addEventListener('click', checkPassword);
        modalCancel.addEventListener('click', hidePasswordModal);
        passwordInput.addEventListener('keydown', (e) => {
             if (e.key === 'Enter') {
                checkPassword();
            }
        });


        // Inicializar
        updateInterfaceControl();

        // ----------------------------------------------------------------------------------
        // --- L√ìGICA DE CONTROL Y SEGURIDAD (ACTUALIZADA CON MODAL) ---
        // ----------------------------------------------------------------------------------
        
        /**
         * Muestra el modal de contrase√±a.
         */
        function showPasswordModal() {
            passwordInput.value = ''; 
            passwordMessage.textContent = ''; 
            passwordModal.classList.add('show');
            passwordInput.focus();
        }

        /**
         * Oculta el modal de contrase√±a.
         */
        function hidePasswordModal() {
            passwordModal.classList.remove('show');
        }

        /**
         * Verifica la contrase√±a introducida en el modal.
         */
        function checkPassword() {
            const passwordAttempt = passwordInput.value;
            
            if (passwordAttempt === MANUAL_MODE_PASSWORD) {
                // Contrase√±a correcta
                passwordMessage.textContent = 'Contrase√±a correcta. Cambiando a Manual.';
                passwordMessage.style.color = var(--color-ok);
                
                // 1. Aplicar el cambio de estado
                controlState.mode = 0; // Modo Manual
                controlState.fan_man = 0; // Apagar actuadores por defecto
                controlState.heat_man = 0;
                
                // 2. Actualizar switch visual y la interfaz
                modeSwitch.checked = false; // Mover el switch visual a OFF/Manual
                updateInterfaceControl();
                sendControlCommand();
                
                // 3. Ocultar modal despu√©s de un breve momento
                setTimeout(hidePasswordModal, 500);
            } else {
                // Contrase√±a incorrecta
                passwordMessage.textContent = 'Contrase√±a incorrecta. Int√©ntalo de nuevo.';
                passwordMessage.style.color = var(--color-alarm);
                passwordInput.value = '';
                passwordInput.focus();
            }
        }


        /**
         * Maneja el cambio de modo con validaci√≥n de contrase√±a.
         */
        function handleModeChange(event) {
            const isChecked = event.target.checked; // true: Auto, false: Manual
            
            // Si intenta cambiar de AUTOM√ÅTICO (1) a MANUAL (0)
            if (!isChecked && controlState.mode === 1) { 
                // 1. Revierte el switch visualmente a Auto (checked=true) temporalmente
                //    hasta que la contrase√±a sea validada o cancelada.
                modeSwitch.checked = true; 
                // 2. Muestra el modal de contrase√±a
                showPasswordModal();
                
            } 
            // Si cambia de MANUAL (0) a AUTOM√ÅTICO (1), no requiere contrase√±a
            else if (isChecked && controlState.mode === 0) {
                controlState.mode = 1;
                updateInterfaceControl();
                sendControlCommand();
            }
            // NOTA: Si la contrase√±a es correcta, checkPassword() se encarga de cambiar el modo
            // controlState.mode = 0 y de mover el modeSwitch.checked = false.
        }


        /**
         * Establece el estado de un actuador en modo manual, asegurando exclusividad.
         */
        function setManualControl(actuator, state) {
            if (controlState.mode === 0) {
                if (actuator === 'fan') {
                    // Si se enciende el ventilador, asegurar que el calefactor est√© OFF
                    if (state === 1) controlState.heat_man = 0;
                    controlState.fan_man = state;
                } else if (actuator === 'heat') {
                    // Si se enciende el calefactor, asegurar que el ventilador est√© OFF
                    if (state === 1) controlState.fan_man = 0;
                    controlState.heat_man = state;
                }
                
                updateInterfaceControl(); 
                sendControlCommand();    
            } else {
                // Mostrar mensaje de advertencia usando la consola (evitando alert())
                console.warn("Para el control manual, por favor, cambia primero a Modo MANUAL.");
            }
        }

        // ----------------------------------------------------------------------------------
        // --- COMUNICACI√ìN Y ACTUALIZACI√ìN DE INTERFAZ ---
        // ----------------------------------------------------------------------------------
        
        /**
         * Env√≠a el objeto de control (modo y estado manual) al ESP32.
         */
        async function sendControlCommand() {
            if (!device || !device.gatt.connected || !controlCharacteristic) {
                console.error("No hay conexi√≥n BLE establecida para enviar comandos.");
                return;
            }

            // Aseguramos que el estado del modo en el switch coincida con el controlState
            modeSwitch.checked = (controlState.mode === 1);
            
            const commandString = JSON.stringify(controlState);
            console.log("Enviando comando: " + commandString);

            try {
                const encoder = new TextEncoder('utf-8');
                await controlCharacteristic.writeValue(encoder.encode(commandString));
            } catch (error) {
                console.error("Error al escribir en la caracter√≠stica BLE:", error);
                statusDiv.textContent = '‚ùå Error al enviar comando: ' + error.message;
            }
        }
        
        /**
         * Actualiza la apariencia de los elementos de control manual (botones, opacidad).
         */
        function updateInterfaceControl() {
            const isManual = controlState.mode === 0;
            currentModeDisplay.textContent = isManual ? 'Manual' : 'Autom√°tico';
            
            // Habilitar/Deshabilitar botones manuales
            fanControlDiv.style.opacity = isManual ? 1 : 0.5;
            heaterControlDiv.style.opacity = isManual ? 1 : 0.5;
            fanOnButton.disabled = !isManual;
            fanOffButton.disabled = !isManual;
            heaterOnButton.disabled = !isManual;
            heaterOffButton.disabled = !isManual;
            
            // Resaltar botones de control manual (solo si est√° en modo Manual)
            if (isManual) {
                // Actualizar resaltado de botones (borde blanco para el bot√≥n activo)
                fanOnButton.style.border = controlState.fan_man === 1 ? '3px solid white' : 'none';
                fanOffButton.style.border = controlState.fan_man === 0 ? '3px solid white' : 'none';
                heaterOnButton.style.border = controlState.heat_man === 1 ? '3px solid white' : 'none';
                heaterOffButton.style.border = controlState.heat_man === 0 ? '3px solid white' : 'none';
            } else {
                 // Resetear apariencia manual en modo autom√°tico
                fanOnButton.style.border = 'none';
                fanOffButton.style.border = 'none';
                heaterOnButton.style.border = 'none';
                heaterOffButton.s
