<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå°Ô∏è SCADA - Monitoreo y Control Ambiental BLE</title>
    <style>
        /* Paleta de Colores Estilo SCADA: */
        :root {
            --bg-dark: #2c3e50; /* Azul/Gris oscuro */
            --bg-card: #34495e; /* Fondo de tarjetas */
            --text-light: #ecf0f1; /* Texto general (blanco/gris claro) */
            --color-ok: #2ecc71; /* Verde es OK/Encendido */
            --color-alarm: #e74c3c; /* Rojo es Alarma/Apagado (para contrastar) */
            --color-highlight: #f39c12; /* Naranja/Amarillo para Promedio/Destacado */
            --color-info: #3498db; /* Azul para estado de conexi√≥n */
        }

        body {
            font-family: 'Consolas', monospace; /* Fuente de estilo t√©cnico */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: var(--bg-dark);
            color: var(--text-light);
        }
        h1, h2 {
            color: var(--text-light);
            text-shadow: 1px 1px 2px #000;
        }
        button, .mode-switch {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            margin: 5px;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #connectButton {
            background-color: var(--color-info);
            color: white;
            margin-bottom: 20px;
        }
        #connectButton:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .status {
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--color-highlight);
        }
        .control-panel, .sensor-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            border: 2px solid var(--color-highlight);
            border-radius: 10px;
            background-color: var(--bg-card);
            width: 90%;
            max-width: 800px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .sensor-card, .actuator-card {
            background-color: var(--bg-dark);
            border: 1px solid var(--text-light);
            border-radius: 8px;
            padding: 10px;
            width: 120px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        .temperature {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--color-alarm);
        }
        #temp_avg {
            color: var(--color-highlight);
        }
        
        /* --- ESTILOS MEJORADOS PARA EL SWITCH --- */
        .mode-switch-container { 
            text-align: center; 
            margin-bottom: 10px; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .mode-label { 
            font-weight: bold; 
            margin-bottom: 10px; 
            color: var(--color-info); 
            width: 100%; /* Asegura que el texto "Modo Actual" se centre */
        }
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 60px; 
            height: 34px; 
            margin: 0 10px;
        }
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        /* El slider (track/pista) */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-alarm); /* Fondo inicial: Rojo (Manual) */
            transition: .4s;
            border-radius: 34px;
        }

        /* El control (thumb/c√≠rculo) */
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text-light);
            transition: .4s;
            border-radius: 50%;
        }

        /* Cuando est√° checked: Mover el thumb y cambiar el fondo */
        input:checked + .slider {
            background-color: var(--color-ok); /* Fondo: Verde (Autom√°tico) */
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .mode-text { 
            font-size: 1.2em; 
            font-weight: bold; 
            margin: 0 15px; 
            transition: opacity 0.3s;
        }
        .mode-text.inactive {
            opacity: 0.4; /* Atenuar el modo no seleccionado */
        }
        #auto-text { color: var(--color-ok); }
        #manual-text { color: var(--color-alarm); }
        /* --- FIN ESTILOS SWITCH --- */
        
        /* Estilos Actuadores */
        .actuator-card { background-color: var(--bg-card); }
        
        /* Botones de control manual */
        .actuator-card button.on { background-color: var(--color-ok); color: var(--bg-dark); }
        .actuator-card button.off { background-color: var(--color-alarm); color: var(--text-light); }
        .actuator-card button:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Estado real del actuador */
        .actuator-status { 
            font-weight: bold; 
            margin-top: 5px;
            color: var(--color-alarm);
        }
        .actuator-status.on {
            color: var(--color-ok);
        }
        
    </style>
</head>
<body>
    <h1>SCADA Term√≥metros Multipunto</h1>
    
    <div id="status" class="status">Desconectado. Pulsa Conectar.</div>
    <button id="connectButton">Conectar a ESP32</button>

    <div class="control-panel">
        <h2>Control de Actuadores</h2>
        
        <div class="mode-switch-container">
            <span id="manual-text" class="mode-text">MANUAL</span>
            <label class="switch">
                <input type="checkbox" id="modeSwitch" checked>
                <span class="slider round"></span>
            </label>
            <span id="auto-text" class="mode-text">AUTOM√ÅTICO</span>
            <div class="mode-label">Modo Actual: <span id="currentMode">Autom√°tico</span></div>
        </div>

        <div class="actuator-card" id="fanControl">
            <h3>Ventilador</h3>
            <button id="fanOnButton" class="on">ON</button>
            <button id="fanOffButton" class="off">OFF</button>
            <div id="fanStatus" class="actuator-status">Estado: OFF</div>
        </div>
        
        <div class="actuator-card" id="heaterControl">
            <h3>Calefactor</h3>
            <button id="heaterOnButton" class="on">ON</button>
            <button id="heaterOffButton" class="off">OFF</button>
            <div id="heaterStatus" class="actuator-status">Estado: OFF</div>
        </div>
    </div>
    
    <h2>Lecturas de Temperatura (¬∞C)</h2>

    <div class="sensor-container">
         <div class="sensor-card">
            <h3>PROMEDIO</h3>
            <div id="temp_avg" class="temperature">--.-</div>
        </div>
        <div class="sensor-card">
            <h3>Sensor 1 (S1)</h3>
            <div id="temp_s1" class="temperature">--.-</div>
        </div>
        <div class="sensor-card">
            <h3>Sensor 2 (S2)</h3>
            <div id="temp_s2" class="temperature">--.-</div>
        </div>
        <div class="sensor-card">
            <h3>Sensor 3 (S3)</h3>
            <div id="temp_s3" class="temperature">--.-</div>
        </div>
        <div class="sensor-card">
            <h3>Sensor 4 (S4)</h3>
            <div id="temp_s4" class="temperature">--.-</div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE SEGURIDAD ---
        // ¬°CAMBIA ESTA CONTRASE√ëA EN UN ENTORNO REAL!
        const MANUAL_MODE_PASSWORD = "1234"; 

        // --- UUIDs (Deben coincidir con tu c√≥digo ESP32) ---
        const DEVICE_NAME = 'TUVN_Termometros'; // Usaremos el nombre para el filtro
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const NOTIFY_CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const CONTROL_CHARACTERISTIC_UUID = '6e400002-b5a3-f39f-e0a9-e50e24dcca9e';

        // Variables BLE
        let device, server, service, notifyCharacteristic, controlCharacteristic;

        // Elementos de la interfaz y estado de control
        const statusDiv = document.getElementById('status');
        const connectButton = document.getElementById('connectButton');
        const modeSwitch = document.getElementById('modeSwitch');
        const currentModeDisplay = document.getElementById('currentMode');
        const manualText = document.getElementById('manual-text');
        const autoText = document.getElementById('auto-text');
        
        const fanControlDiv = document.getElementById('fanControl');
        const heaterControlDiv = document.getElementById('heaterControl');
        const fanOnButton = document.getElementById('fanOnButton');
        const fanOffButton = document.getElementById('fanOffButton');
        const heaterOnButton = document.getElementById('heaterOnButton');
        const heaterOffButton = document.getElementById('heaterOffButton');
        const fanStatusDiv = document.getElementById('fanStatus');
        const heaterStatusDiv = document.getElementById('heaterStatus');

        const tempsDivs = {
            avg: document.getElementById('temp_avg'),
            s1: document.getElementById('temp_s1'),
            s2: document.getElementById('temp_s2'),
            s3: document.getElementById('temp_s3'),
            s4: document.getElementById('temp_s4')
        };
        
        let controlState = {
            mode: 1,      // 1: Autom√°tico, 0: Manual
            fan_man: 0,   // Control Manual Ventilador
            heat_man: 0   // Control Manual Calefactor
        };


        // --- Event Listeners ---
        connectButton.addEventListener('click', connectToBLE);
        modeSwitch.addEventListener('change', handleModeChange);
        fanOnButton.addEventListener('click', () => setManualControl('fan', 1));
        fanOffButton.addEventListener('click', () => setManualControl('fan', 0));
        heaterOnButton.addEventListener('click', () => setManualControl('heat', 1));
        heaterOffButton.addEventListener('click', () => setManualControl('heat', 0));

        // Inicializar interfaz
        updateInterfaceControl();

        // ----------------------------------------------------------------------------------
        // --- L√ìGICA DE CONTROL Y SEGURIDAD ---
        // ----------------------------------------------------------------------------------

        /**
         * Maneja el cambio de modo con validaci√≥n de contrase√±a.
         */
        function handleModeChange(event) {
            const isChecked = event.target.checked; // true: Auto, false: Manual
            
            // Si intenta cambiar de AUTOM√ÅTICO (1) a MANUAL (0)
            if (!isChecked && controlState.mode === 1) { 
                const passwordAttempt = prompt("MODO MANUAL requiere contrase√±a:");
                
                if (passwordAttempt !== MANUAL_MODE_PASSWORD) {
                    alert("Contrase√±a incorrecta. Se mantiene en Modo AUTOM√ÅTICO.");
                    // Revertir el estado del switch en la interfaz (Mantener en ON/checked)
                    modeSwitch.checked = true;
                    // Forzar la actualizaci√≥n visual para corregir si el navegador lo movi√≥ antes
                    updateInterfaceControl(); 
                    return; // No cambia el modo
                }
                
                // Contrase√±a correcta: Iniciar modo manual con actuadores apagados
                controlState.fan_man = 0;
                controlState.heat_man = 0;
            }

            // Si pasa la seguridad (o si cambia de Manual a Auto), actualiza el estado
            controlState.mode = isChecked ? 1 : 0; // 1: Auto, 0: Manual
            updateInterfaceControl();
            sendControlCommand();
        }


        /**
         * Establece el estado de un actuador en modo manual, asegurando exclusividad.
         */
        function setManualControl(actuator, state) {
            if (controlState.mode === 0) {
                // L√≥gica de exclusividad (Ventilador y Calefactor no pueden estar ON al mismo tiempo)
                if (actuator === 'fan') {
                    if (state === 1) controlState.heat_man = 0; // Apagar calefactor si se enciende el ventilador
                    controlState.fan_man = state;
                } else if (actuator === 'heat') {
                    if (state === 1) controlState.fan_man = 0; // Apagar ventilador si se enciende el calefactor
                    controlState.heat_man = state;
                }
                
                updateInterfaceControl(); 
                sendControlCommand();    
            } else {
                alert("Para el control manual, por favor, cambia primero a Modo MANUAL. (Requiere contrase√±a)");
                // Asegurar que el switch visual est√© en Autom√°tico
                modeSwitch.checked = true; 
            }
        }

        // ----------------------------------------------------------------------------------
        // --- COMUNICACI√ìN Y ACTUALIZACI√ìN DE INTERFAZ ---
        // ----------------------------------------------------------------------------------
        
        /**
         * Env√≠a el objeto de control (modo y estado manual) al ESP32.
         */
        async function sendControlCommand() {
            if (!device || !device.gatt.connected || !controlCharacteristic) {
                console.error("No hay conexi√≥n BLE establecida para enviar comandos.");
                return;
            }

            const commandString = JSON.stringify(controlState);
            console.log("Enviando comando: " + commandString);

            try {
                const encoder = new TextEncoder('utf-8');
                await controlCharacteristic.writeValue(encoder.encode(commandString));
            } catch (error) {
                console.error("Error al escribir en la caracter√≠stica BLE:", error);
                // Si hay un error de escritura, es probable que la conexi√≥n se haya perdido
                statusDiv.textContent = '‚ùå Error al enviar comando. Revisando conexi√≥n...';
                // Intenta verificar la desconexi√≥n
                if (device && !device.gatt.connected) {
                    onDisconnected({ target: device }); 
                }
            }
        }
        
        /**
         * Actualiza la apariencia de los elementos de control manual (botones, opacidad) y el modo.
         */
        function updateInterfaceControl() {
            const isManual = controlState.mode === 0;
            currentModeDisplay.textContent = isManual ? 'Manual' : 'Autom√°tico';
            
            // L√≥gica de atenuaci√≥n de texto del modo
            if (isManual) {
                manualText.classList.remove('inactive');
                autoText.classList.add('inactive');
            } else { // Autom√°tico
                manualText.classList.add('inactive');
                autoText.classList.remove('inactive');
            }
            
            // Habilitar/Deshabilitar botones manuales
            fanControlDiv.style.opacity = isManual ? 1 : 0.5;
            heaterControlDiv.style.opacity = isManual ? 1 : 0.5;
            fanOnButton.disabled = !isManual;
            fanOffButton.disabled = !isManual;
            heaterOnButton.disabled = !isManual;
            heaterOffButton.disabled = !isManual;
            
            // Resaltar botones de control manual (solo si est√° en modo Manual)
            if (isManual) {
                // Actualizar resaltado de botones (borde blanco para el estado activo)
                fanOnButton.style.border = controlState.fan_man === 1 ? '3px solid white' : 'none';
                fanOffButton.style.border = controlState.fan_man === 0 ? '3px solid white' : 'none';
                heaterOnButton.style.border = controlState.heat_man === 1 ? '3px solid white' : 'none';
                heaterOffButton.style.border = controlState.heat_man === 0 ? '3px solid white' : 'none';
            } else {
                 // Resetear apariencia manual en modo autom√°tico
                fanOnButton.style.border = 'none';
                fanOffButton.style.border = 'none';
                heaterOnButton.style.border = 'none';
                heaterOffButton.style.border = 'none';
            }
        }

        /**
         * Actualiza el estado visual de los actuadores (estado real recibido del ESP32).
         */
        function updateActuatorStatus(fanState, heaterState) {
            fanStatusDiv.textContent = `Estado: ${fanState ? 'ON' : 'OFF'}`;
            fanStatusDiv.classList.toggle('on', fanState === 1);
            
            heaterStatusDiv.textContent = `Estado: ${heaterState ? 'ON' : 'OFF'}`;
            heaterStatusDiv.classList.toggle('on', heaterState === 1);
        }

        // ----------------------------------------------------------------------------------
        // --- FUNCIONES BLE EST√ÅNDAR (MEJORADAS) ---
        // ----------------------------------------------------------------------------------

        async function connectToBLE() {
            if (!navigator.bluetooth) {
                statusDiv.textContent = '‚ùå Web Bluetooth no soportado en este navegador.';
                console.error('Web Bluetooth API not available.');
                return;
            }
            
            try {
                statusDiv.textContent = 'Buscando dispositivo...';
                
                // 1. Solicitar Dispositivo
                device = await navigator.bluetooth.requestDevice({
                    // Puedes buscar por nombre O por UUIDs, usando filtros para aumentar la probabilidad de √©xito.
                    filters: [{ name: DEVICE_NAME }], 
                    // Usar optionalServices permite que el navegador muestre m√°s dispositivos y luego filtre.
                    optionalServices: [SERVICE_UUID] 
                });

                // Registrar el listener de desconexi√≥n antes de conectar
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                statusDiv.textContent = `Conectando a ${device.name}...`;
                
                // 2. Conectar al GATT Server
                server = await device.gatt.connect();
                statusDiv.textContent = 'Servidor GATT conectado. Buscando servicio...';

                // 3. Obtener Servicio
                service = await server.getPrimaryService(SERVICE_UUID);
                statusDiv.textContent = 'Servicio encontrado. Buscando caracter√≠sticas...';

                // 4. Obtener Caracter√≠sticas
                notifyCharacteristic = await service.getCharacteristic(NOTIFY_CHARACTERISTIC_UUID);
                controlCharacteristic = await service.getCharacteristic(CONTROL_CHARACTERISTIC_UUID);
                statusDiv.textContent = 'Caracter√≠sticas encontradas. Iniciando notificaciones...';

                // 5. Iniciar Notificaciones
                await notifyCharacteristic.startNotifications();
                notifyCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                statusDiv.textContent = '‚úÖ Conectado y recibiendo datos.';
                connectButton.textContent = 'Desconectar';
                connectButton.removeEventListener('click', connectToBLE);
                connectButton.addEventListener('click', disconnectBLE);

                // Enviar estado d
